<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.moodcalendar.mapper.DiaryMapper">
  <select id="selectDiaryById" parameterType="long" resultType="com.example.moodcalendar.domain.Diary">
    SELECT *
      FROM diary
     WHERE id = #{id}
  </select>

  <select id="selectDiariesByUserId" parameterType="long"
    resultType="com.example.moodcalendar.dto.response.DiaryResponseDto">
    SELECT    d.id
              ,d.user_id
              ,d.emotion_id
              ,e.name AS emotion_name
              ,e.emoji AS emoji
              ,d.content
              ,d.diary_date
              ,d.is_public
              ,d.created_at
               ,d.updated_at
    FROM      diary d
    LEFT JOIN emotion e
           ON d.emotion_id = e.id
    WHERE d.user_id = #{userId}
  </select>

  <insert id="insertDiary" parameterType="com.example.moodcalendar.domain.Diary" useGeneratedKeys="true" keyProperty="id">
    INSERT INTO diary (
                  user_id
    <if test="emotionId != null">
                ,emotion_id
    </if>
                ,content
                ,diary_date
                ,is_public
                ,created_at
                ,updated_at
    )
    VALUES (
                #{userId}
    <if test="emotionId != null">
              ,#{emotionId}
    </if>
              ,#{content}
              ,#{diaryDate}
              ,#{isPublic}
              ,NOW()
              ,NOW()
    )
  </insert>

  <update id="updateDiary" parameterType="com.example.moodcalendar.domain.Diary">
    UPDATE diary
    <set>
      <if test="emotionId != null">emotion_id = #{emotionId},</if>
      <if test="content != null">content = #{content},</if>
      <if test="diaryDate != null">diary_date = #{diaryDate},</if>
      <if test="isPublic != null">is_public = #{isPublic},</if>
      updated_at = NOW()
    </set>
    WHERE id = #{id}
  </update>

  <delete id="deleteDiaryById" parameterType="long">
    DELETE FROM diary
     WHERE id = #{id}
  </delete>

  <select id="selectDiaryWithEmotion" parameterType="long"
    resultType="com.example.moodcalendar.dto.response.DiaryResponseDto">
    SELECT       d.id
                ,d.user_id
                ,d.emotion_id
                ,e.name AS emotion_name
                ,e.emoji AS emoji
                ,d.content
                ,d.diary_date
                ,d.is_public
                ,d.created_at
                ,d.updated_at
      FROM      diary d
      LEFT JOIN emotion e ON d.emotion_id = e.id
    WHERE d.id = #{id}
  </select>

</mapper>
